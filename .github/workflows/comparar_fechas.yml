name: Comparar Fechas y Subir a OneDrive

on:
  workflow_dispatch:   # Ejecutar manual
  #schedule:
  #  - cron: "0 10 * * *"  # Todos los días a las 10:00 UTC

jobs:
  procesar:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Clonar repositorio
    - name: 📥 Checkout
      uses: actions/checkout@v3

    # 2️⃣ Configurar Python
    - name: 🐍 Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 3️⃣ Instalar dependencias
    - name: 📦 Instalar librerías
      run: pip install -r requirements.txt && pip install webdriver-manager

    # 4️⃣ Crear carpeta local data/
    - name: 📁 Crear carpeta data/
      run: mkdir -p data

    # 5️⃣ Instalar Rclone
    - name: ⚙️ Instalar Rclone
      run: curl https://rclone.org/install.sh | sudo bash

    # 6️⃣ Descargar archivos desde OneDrive
    - name: 📥 Descargar archivos desde OneDrive
      env:
        AUTOMATE_RCLONE: ${{ secrets.AUTOMATE_RCLONE }}
      run: |
        echo "$AUTOMATE_RCLONE" > rclone.conf
        rclone --config rclone.conf copy "ondri_a.formularios:a.Formularios/Forms Cierre de Voluntariado.xlsx" data/
        rclone --config rclone.conf copy "ondri_a.formularios:a.Formularios/Te damos la bienvenida__Dirección de Cultura Organizacional y Talento Humano.xlsx" data/
        rclone --config rclone.conf copy "ondri_a.formularios:a.Formularios/DNI_OBS.xlsx" data/

    # 7️⃣ Ejecutar Script 1 (merge y observaciones de fechas)
    - name: ▶️ Ejecutar Script 1
      run: python COMPARACION_GLOBAL.py
    
    # 7️⃣ Ejecutar Script 1 (merge y observaciones de fechas)
   # - name: ▶️ Ejecutar Script 1
    #  run: python script_merge.py
    
   # 8️⃣ Ejecutar Script 2 (Selenium)
  # - name: ▶️ Ejecutar Script 2
   #   run: python script_selenium.py

   # 8️⃣ Ejecutar Script 3 (SUNAT)
   # - name: ▶️ Ejecutar Script 3
    #  run: python comparar_con_sunat.py
    
    
    
    # 📦 Subir carpeta DEBUG_FOLDER como artefacto
    - name: 📤 Subir carpeta DEBUG_FOLDER
      uses: actions/upload-artifact@v4
      with:
        name: debug-folder
        path: DEBUG_FOLDER
    
    # 9️⃣ Subir archivo final a OneDrive
    - name: ☁️ Subir archivo final
      env:
        AUTOMATE_RCLONE: ${{ secrets.AUTOMATE_RCLONE }}
      run: |
        echo "$AUTOMATE_RCLONE" > rclone.conf
        rclone --config rclone.conf copy TEST_salida/ "ondri_a.formularios:a.Formularios/" --include "*.xlsx" --progress


